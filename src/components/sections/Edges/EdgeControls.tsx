/**
 * Visual Controls Component
 * Controls for customizing the visual appearance of polytopes edges and raymarching rim lighting (which appears as pseudo-edges).
 */

import { Slider } from '@/components/ui/Slider';
import { ColorPicker } from '@/components/ui/ColorPicker';
import { ControlGroup } from '@/components/ui/ControlGroup';
import { Switch } from '@/components/ui/Switch';
import { useAppearanceStore, type AppearanceSlice } from '@/stores/appearanceStore';
import React from 'react';
import { useShallow } from 'zustand/react/shallow';
import { EdgeMaterialControls } from './EdgeMaterialControls';

export interface EdgesControlsProps {
  className?: string;
}

export const EdgeControls: React.FC<EdgesControlsProps> = React.memo(({
  className = '',
}) => {
  // Consolidate visual store selectors with useShallow to reduce subscriptions
  const appearanceSelector = useShallow((state: AppearanceSlice) => ({
    edgeColor: state.edgeColor,
    edgeThickness: state.edgeThickness,
    tubeCaps: state.tubeCaps,
    setEdgeColor: state.setEdgeColor,
    setEdgeThickness: state.setEdgeThickness,
    setTubeCaps: state.setTubeCaps,
  }));
  const {
    edgeColor,
    edgeThickness,
    tubeCaps,
    setEdgeColor,
    setEdgeThickness,
    setTubeCaps,
  } = useAppearanceStore(appearanceSelector);

  return (
    <div className={`space-y-4 ${className}`}>
      <ControlGroup title="Appearance" defaultOpen>
        {/* Edge Color */}
        <ColorPicker
            label="Edge Color"
            value={edgeColor}
            onChange={setEdgeColor}
            disableAlpha={true}
        />

        {/* Edge Thickness */}
        <Slider
            label="Edge Thickness"
            min={0}
            max={5}
            step={0.1}
            value={edgeThickness}
            onChange={setEdgeThickness}
            showValue
        />

        {/* Tube End Caps - only visible when using tube rendering (thickness > 1) */}
        {edgeThickness > 1 && (
          <Switch
            checked={tubeCaps}
            onCheckedChange={setTubeCaps}
            label="Tube End Caps"
            data-testid="tube-caps-toggle"
          />
        )}
      </ControlGroup>

      {/* Edge Material Controls (only visible when thickness > 1) */}
      <EdgeMaterialControls />
    </div>
  );
});
