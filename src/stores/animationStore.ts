/**
 * Animation state management using Zustand
 * Manages auto-rotation animation for n-dimensional objects
 */

import { getRotationPlanes } from '@/lib/math/rotation'
import { create } from 'zustand'

/** Minimum animation speed multiplier */
export const MIN_SPEED = 0.1

/** Maximum animation speed multiplier */
export const MAX_SPEED = 3.0

/** Default animation speed (1x = one full rotation per 10 seconds) */
export const DEFAULT_SPEED = 0.4

/** Base rotation rate in radians per second at 1x speed */
export const BASE_ROTATION_RATE = (2 * Math.PI) / 10 // Full rotation in 10 seconds

interface AnimationState {
  /** Whether animation is currently playing */
  isPlaying: boolean

  /** Speed multiplier (0.1 to 5.0) */
  speed: number

  /** Rotation direction: 1 = clockwise, -1 = counter-clockwise */
  direction: 1 | -1

  /** Set of planes currently being animated */
  animatingPlanes: Set<string>

  // Actions
  play: () => void
  pause: () => void
  toggle: () => void
  setSpeed: (speed: number) => void
  toggleDirection: () => void
  togglePlane: (plane: string) => void
  setPlaneAnimating: (plane: string, animating: boolean) => void
  animateAll: (dimension: number) => void
  resetToFirstPlane: (dimension: number) => void
  clearAllPlanes: () => void
  stopAll: () => void
  setDimension: (dimension: number) => void
  reset: () => void

  /** Calculate the rotation delta for a given time delta */
  getRotationDelta: (deltaTimeMs: number) => number
}

/**
 * Clamps speed to valid range
 * @param speed - Speed value to clamp
 * @returns Clamped speed value between MIN_SPEED and MAX_SPEED
 */
function clampSpeed(speed: number): number {
  return Math.max(MIN_SPEED, Math.min(MAX_SPEED, speed))
}

/**
 * Gets all rotation plane names for a given dimension
 * @param dimension - The dimension to get planes for
 * @returns Array of rotation plane names
 */
function getAllPlaneNames(dimension: number): string[] {
  return getRotationPlanes(dimension).map((p) => p.name)
}

export const useAnimationStore = create<AnimationState>((set, get) => ({
  isPlaying: true,
  speed: DEFAULT_SPEED,
  direction: 1,
  animatingPlanes: new Set(['XY', 'YZ', 'ZW']),

  play: () => {
    set({ isPlaying: true })
  },

  pause: () => {
    set({ isPlaying: false })
  },

  toggle: () => {
    set((state) => ({ isPlaying: !state.isPlaying }))
  },

  setSpeed: (speed: number) => {
    set({ speed: clampSpeed(speed) })
  },

  toggleDirection: () => {
    set((state) => ({ direction: state.direction === 1 ? -1 : 1 }))
  },

  togglePlane: (plane: string) => {
    set((state) => {
      const newPlanes = new Set(state.animatingPlanes)
      if (newPlanes.has(plane)) {
        newPlanes.delete(plane)
      } else {
        newPlanes.add(plane)
      }
      return { animatingPlanes: newPlanes }
    })
  },

  setPlaneAnimating: (plane: string, animating: boolean) => {
    set((state) => {
      const newPlanes = new Set(state.animatingPlanes)
      if (animating) {
        newPlanes.add(plane)
      } else {
        newPlanes.delete(plane)
      }
      return { animatingPlanes: newPlanes }
    })
  },

  animateAll: (dimension: number) => {
    const planes = getAllPlaneNames(dimension)
    set({ animatingPlanes: new Set(planes), isPlaying: true })
  },

  resetToFirstPlane: (dimension: number) => {
    const planes = getAllPlaneNames(dimension)
    if (planes.length > 0 && planes[0]) {
      set({ animatingPlanes: new Set([planes[0]]), isPlaying: true })
    }
  },

  clearAllPlanes: () => {
    set({ animatingPlanes: new Set() })
  },

  stopAll: () => {
    set({ animatingPlanes: new Set(), isPlaying: false })
  },

  setDimension: (dimension: number) => {
    set((state) => {
      // Filter animating planes to only include valid planes for new dimension
      const validPlanes = new Set(getAllPlaneNames(dimension))
      const newAnimatingPlanes = new Set<string>()

      for (const plane of state.animatingPlanes) {
        if (validPlanes.has(plane)) {
          newAnimatingPlanes.add(plane)
        }
      }

      return { animatingPlanes: newAnimatingPlanes }
    })
  },

  reset: () => {
    set({
      isPlaying: true,
      speed: DEFAULT_SPEED,
      direction: 1,
      animatingPlanes: new Set(['XY', 'YZ', 'ZW']),
    })
  },

  getRotationDelta: (deltaTimeMs: number) => {
    const state = get()
    const deltaTimeSec = deltaTimeMs / 1000
    return BASE_ROTATION_RATE * state.speed * state.direction * deltaTimeSec
  },
}))
