# Physical Fog + Bloom White Screen Bug Log

- 2025-12-19: Initialized log file. File did not exist prior to creation.
- 2025-12-19: Ran baseline test via `npm run dev & sleep 5` + `node scripts/playwright/physical-fog-white-screen.spec.mjs`. Vite auto-selected http://localhost:3002/ because 3000/3001 in use; test still navigated to http://localhost:3000 and failed. Screenshot timed out (GPU stall), ReadPixels stall warnings in console. Store access result: no-store-found; UI fallback used. No shader compile errors shown.
- 2025-12-19: Reviewed `docs/meta/styleguide.md` WebGL2/GLSL ES 3.00 requirements: ShaderMaterial must set `glslVersion: THREE.GLSL3`; shaders must use `in`/`out`, `layout(location=...) out`, and `texture()` (no `varying`, `gl_FragColor`, or `texture2D`).
- 2025-12-19: Inspected `src/rendering/passes/VolumetricFogPass.ts` and `src/rendering/shaders/postprocessing/VolumetricFogShader.ts`; both already use GLSL ES 3.00 syntax (`glslVersion: THREE.GLSL3`, `in/out`, `layout(location=0) out vec4 fragColor`, `texture()`), and the fog shader already clamps scattering/accumulated color.
- 2025-12-19: Reviewed `scripts/playwright/physical-fog-white-screen.spec.mjs`; test hardcodes http://localhost:3000 and uses store/localStorage fallback to enable fog. If dev server starts on a different port, the test will hit an unrelated app.
- 2025-12-19: Detected an existing process listening on port 3000 (node PID 14386), which likely caused Vite to start on 3002 while the test still targeted 3000.
- 2025-12-19: `useEnvironmentStore` is not persisted (no localStorage key like `environment-storage`), so the testâ€™s localStorage injection always fails and relies on UI toggles.
- 2025-12-19: Killed existing process on port 3000 (PID 14386) to allow Vite dev server to bind to the test's required port.
- 2025-12-19: Re-ran baseline with Vite on port 3000. Test still failed at screenshot step (timeout 5000ms) with repeated WebGL GPU stall due to ReadPixels; no shader compile errors logged. No pixel analysis results because screenshot failed.
- 2025-12-19: Hypothesis: GPU stall during Playwright screenshot is due to heavy physical fog raymarching + bloom on SwiftShader (software renderer). Plan to add adaptive fog quality (reduced steps / resolution / 2D noise) when software renderer detected.
- 2025-12-19: User directive: do not use software renderers; GPU-only. Need to remove SwiftShader/software-specific fallback logic and avoid relying on software rendering for tests.
- 2025-12-19: Reverted adaptive fog step/resolution changes and removed software-renderer detection logic per user request (GPU-only). Files restored: `src/rendering/shaders/postprocessing/VolumetricFogShader.ts`, `src/rendering/passes/VolumetricFogPass.ts`, `src/rendering/environment/PostProcessing.tsx`.
- 2025-12-19: Added NaN/Inf guards and clamps in `src/rendering/shaders/postprocessing/VolumetricFogShader.ts` to prevent invalid depth/world position/raymarch values from propagating into HDR output (potentially causing white-out/stall).
- 2025-12-19: After adding NaN/Inf guards in fog shader, reran `node scripts/playwright/physical-fog-white-screen.spec.mjs` with Vite on 3000. Test PASSED. Gate metrics: black 27.6%, avg brightness 44.5/255, brightness range 204, white 0.0%, no WebGL errors. Screenshot: `screenshots/physical-fog-test.png`.
- 2025-12-19: Updated app defaults to enable fog + physical fog by default per user request: `src/stores/slices/fogSlice.ts` (DEFAULT_FOG_STATE). Adjusted fog slice tests to match new defaults.
- 2025-12-19: Re-ran test after setting physical fog default enabled. Test FAILED Gate 1: 100% black, avg brightness 0, range 0. Gates 2-4 pass. Console shows GPU stall warnings (ReadPixels). Screenshot written to `screenshots/physical-fog-test.png`.
- 2025-12-19: Identified likely bug: `VolumetricFogPass.render()` used writeBuffer as input and readBuffer as output (parameter order reversed). Fixed to sample from `readBuffer` and render to `writeBuffer`.
- 2025-12-19: User reports new bug after fix: physical fog now renders without stalls/white-out, but fog appears as flickering, nearly transparent overlay.
- 2025-12-19: Attempted flicker fix: fog shader now uses stable `vUv` for sampling instead of `gl_FragCoord` (still derives pixel coords for dither). Updated `src/rendering/shaders/postprocessing/VolumetricFogShader.ts`.
- 2025-12-19: Attempted flicker fix #2: replaced screen-space dither with world-space hash dither (stable per world position) in `src/rendering/shaders/postprocessing/VolumetricFogShader.ts` to reduce flicker/shimmer.
